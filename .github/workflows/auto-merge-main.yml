name: Auto PR & Merge → Main

on:
  push:
    branches: [develop]
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["PR Checks"]
    types: [completed]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  # Job 1: Criar PR automático de develop → main quando develop recebe push
  create-pr:
    name: Criar PR develop → main
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Criar ou atualizar PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verificar se develop está à frente de main
          git fetch origin main
          AHEAD_COUNT=$(git rev-list --count origin/main..HEAD)
          if [ "$AHEAD_COUNT" -eq 0 ]; then
            echo "develop não está à frente de main. Nada a fazer."
            exit 0
          fi

          # Verificar se já existe PR aberto
          EXISTING=$(gh pr list --head develop --base main --state open --json number --jq '.[0].number // empty')

          # Coletar mensagem completa do último commit
          COMMIT_MSG=$(git log -1 --format="%B")
          COMMIT_SUBJECT=$(git log -1 --format="%s")

          # Listar todos os commits pendentes (develop à frente de main)
          PENDING_COMMITS=$(git log origin/main..HEAD --format="- %s" --no-merges)

          # Corpo da PR com a mensagem do commit e lista de commits pendentes
          BODY=$(cat <<EOF
          ${COMMIT_MSG}

          ---

          ### Commits pendentes
          ${PENDING_COMMITS}
          EOF
          )

          if [ -n "$EXISTING" ]; then
            echo "PR #${EXISTING} já existe. Atualizando descrição..."
            gh pr edit "$EXISTING" \
              --title "${COMMIT_SUBJECT}" \
              --body "$BODY"
            echo "PR #${EXISTING} atualizado."
          else
            echo "Criando PR develop → main..."
            gh pr create \
              --title "${COMMIT_SUBJECT}" \
              --body "$BODY" \
              --base main \
              --head develop
            echo "PR criado com sucesso!"
          fi

  # Job 2: Auto-merge após aprovação manual
  auto-merge-on-approval:
    name: Auto-merge após aprovação
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'pull_request_review' &&
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - name: Verificar e fazer merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"

          echo "PR #${PR_NUM} aprovado para merge em main"

          CHECKS_STATUS=$(gh pr checks "$PR_NUM" --json bucket --jq '[.[] | .bucket] | if all(. == "pass" or . == "skipped") then "ok" else "pending" end' 2>/dev/null || echo "pending")

          if [ "$CHECKS_STATUS" = "ok" ]; then
            echo "Todos os checks passaram. Fazendo merge..."
            gh pr merge "$PR_NUM" --merge --delete-branch=false || {
              echo "Merge direto falhou. Habilitando auto-merge..."
              gh pr merge "$PR_NUM" --merge --auto --delete-branch=false
            }
          else
            echo "Checks ainda pendentes. Habilitando auto-merge..."
            gh pr merge "$PR_NUM" --merge --auto --delete-branch=false
          fi

  # Job 3: Auto-merge develop → main quando checks passam
  auto-merge-on-checks:
    name: Auto-merge develop → main (checks passed)
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'check_suite' && github.event.check_suite.conclusion == 'success')
    steps:
      - uses: actions/checkout@v4

      - name: Buscar e mergear PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(gh pr list --head develop --base main --state open --json number --jq '.[0].number // empty')

          if [ -z "$PR_NUM" ]; then
            echo "Nenhum PR aberto de develop → main."
            exit 0
          fi

          echo "Encontrado PR #${PR_NUM}"

          CHECKS_STATUS=$(gh pr checks "$PR_NUM" --json bucket --jq '[.[] | .bucket] | if all(. == "pass" or . == "skipped") then "ok" else "pending" end' 2>/dev/null || echo "pending")

          if [ "$CHECKS_STATUS" = "ok" ]; then
            echo "Todos os checks passaram. Fazendo merge..."
            gh pr merge "$PR_NUM" --merge --delete-branch=false || {
              echo "Merge direto falhou. Habilitando auto-merge..."
              gh pr merge "$PR_NUM" --merge --auto --delete-branch=false
            }
          else
            echo "Checks pendentes. Habilitando auto-merge..."
            gh pr merge "$PR_NUM" --merge --auto --delete-branch=false
          fi
