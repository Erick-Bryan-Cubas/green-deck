name: Auto Merge → Main (após aprovação)

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge-on-approval:
    name: Auto-merge develop → main
    runs-on: ubuntu-latest
    # Só executa quando o review é aprovação E o PR é para main
    if: >
      github.event.review.state == 'approved' &&
      github.event.pull_request.base.ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - name: Verificar e fazer merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          HEAD="${{ github.event.pull_request.head.ref }}"

          echo "PR #${PR_NUM} aprovado para merge em main"
          echo "Branch de origem: $HEAD"

          # Verificar que a branch de origem é develop
          if [ "$HEAD" != "develop" ]; then
            echo "AVISO: Branch de origem não é 'develop' (é '$HEAD')."
            echo "Apenas PRs de develop→main são auto-mergeados."
            echo "Habilitando auto-merge mesmo assim (será feito quando checks passarem)..."
          fi

          # Verificar se todos os checks passaram
          CHECKS_STATUS=$(gh pr checks "$PR_NUM" --json bucket --jq '[.[] | .bucket] | if all(. == "pass" or . == "skipped") then "ok" else "pending" end' 2>/dev/null || echo "pending")

          if [ "$CHECKS_STATUS" = "ok" ]; then
            echo "Todos os checks passaram. Fazendo merge..."
            gh pr merge "$PR_NUM" --merge --delete-branch=false || {
              echo "Merge direto falhou. Habilitando auto-merge..."
              gh pr merge "$PR_NUM" --merge --auto --delete-branch=false
            }
          else
            echo "Checks ainda pendentes. Habilitando auto-merge para quando concluírem..."
            gh pr merge "$PR_NUM" --merge --auto --delete-branch=false
          fi

          echo "Merge configurado com sucesso para PR #${PR_NUM}!"
