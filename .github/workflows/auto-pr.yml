name: Auto PR

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'fix/**'
      - 'hotfix/**'
      - 'refactor/**'
      - 'docs/**'
      - 'style/**'
      - 'perf/**'
      - 'test/**'
      - 'ci/**'
      - 'chore/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-pr:
    name: Criar PR autom√°tico
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detectar tipo e criar PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          TYPE=$(echo "$BRANCH" | cut -d'/' -f1)
          NAME=$(echo "$BRANCH" | cut -d'/' -f2- | tr '-' ' ' | tr '_' ' ')

          echo "Branch: $BRANCH"
          echo "Tipo: $TYPE"
          echo "Nome: $NAME"

          # Verificar se j√° existe PR para esta branch
          EXISTING=$(gh pr list --head "$BRANCH" --base develop --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING" ]; then
            echo "PR #${EXISTING} j√° existe para esta branch. Pulando cria√ß√£o."
            exit 0
          fi

          # Mapear tipo para emoji e label
          case "$TYPE" in
            feature)  EMOJI="‚ú®"; LABEL="feature";  DESC="Nova funcionalidade" ;;
            bugfix)   EMOJI="üêõ"; LABEL="bugfix";   DESC="Corre√ß√£o de bug" ;;
            fix)      EMOJI="üêõ"; LABEL="bugfix";   DESC="Corre√ß√£o de bug" ;;
            hotfix)   EMOJI="üöë"; LABEL="hotfix";   DESC="Corre√ß√£o urgente" ;;
            refactor) EMOJI="‚ôªÔ∏è";  LABEL="refactor"; DESC="Refatora√ß√£o" ;;
            docs)     EMOJI="üìù"; LABEL="docs";     DESC="Documenta√ß√£o" ;;
            style)    EMOJI="üíÑ"; LABEL="style";    DESC="Estilo/UI" ;;
            perf)     EMOJI="‚ö°"; LABEL="perf";     DESC="Performance" ;;
            test)     EMOJI="‚úÖ"; LABEL="test";     DESC="Testes" ;;
            ci)       EMOJI="üë∑"; LABEL="ci";       DESC="CI/CD" ;;
            chore)    EMOJI="üîß"; LABEL="chore";    DESC="Manuten√ß√£o" ;;
            *)        EMOJI="üì¶"; LABEL="other";    DESC="Altera√ß√£o" ;;
          esac

          # Gerar t√≠tulo do PR
          TITLE="${EMOJI} ${DESC}: ${NAME}"

          # Coletar commits da branch
          COMMITS=$(git log origin/develop..HEAD --oneline --no-merges 2>/dev/null || echo "Commits n√£o dispon√≠veis")

          # Criar corpo do PR
          BODY=$(cat <<EOF
          ## ${DESC}

          **Branch:** \`${BRANCH}\`
          **Tipo:** ${EMOJI} ${TYPE}

          ### Commits
          \`\`\`
          ${COMMITS}
          \`\`\`

          ---
          > PR criado automaticamente pelo pipeline CI/CD
          EOF
          )

          # Criar label se n√£o existir
          gh label create "$LABEL" --description "$DESC" --color "0E8A16" 2>/dev/null || true

          # Criar PR
          gh pr create \
            --title "$TITLE" \
            --body "$BODY" \
            --base develop \
            --head "$BRANCH" \
            --label "$LABEL"

          echo "PR criado com sucesso!"
